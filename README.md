# idp-octelium-sync

A universal tool for syncing users and groups from Identity Providers (Keycloak, Okta, Azure AD) to [Octelium](https://octelium.com/) manifests.

## Features

- Sync users and groups from IdP to Octelium YAML manifests
- GitOps-compatible: generates YAML files for use with `octeliumctl apply`
- Plugin architecture: supports multiple Identity Providers
- Flexible group-to-policy mapping via `group-mapping.yaml`
- User filtering with glob patterns

## Supported Providers

- [x] Keycloak
- [ ] Okta (planned)
- [ ] Azure AD (planned)

## Installation

```bash
# Local development with Bun
bun install
bun run src/index.ts sync --help

# Via Docker
docker pull ghcr.io/neuroplume/idp-octelium-sync:latest
```

## Usage

### CLI

```bash
# Sync from Keycloak
bun run src/index.ts sync \
  --provider keycloak \
  --keycloak-url https://keycloak.example.com \
  --keycloak-realm master \
  --keycloak-client-id admin-cli \
  --keycloak-client-secret $KEYCLOAK_CLIENT_SECRET \
  --mapping ./manual/group-mapping.yaml \
  --output-users ./generated/users.yaml \
  --output-groups ./generated/groups.yaml \
  --exclude-users "service-*,admin"

# Dry run - print output without writing files
bun run src/index.ts sync \
  --provider keycloak \
  ... \
  --dry-run
```

### Docker

```bash
docker run --rm \
  -e KEYCLOAK_CLIENT_SECRET=xxx \
  -v $(pwd):/data \
  ghcr.io/neuroplume/idp-octelium-sync:latest sync \
  --provider keycloak \
  --keycloak-url https://keycloak.example.com \
  --keycloak-realm master \
  --keycloak-client-id admin-cli \
  --mapping /data/manual/group-mapping.yaml \
  --output-users /data/generated/users.yaml \
  --output-groups /data/generated/groups.yaml
```

### Environment Variables

| Variable | Description |
|----------|-------------|
| `KEYCLOAK_URL` | Keycloak server URL |
| `KEYCLOAK_REALM` | Realm name |
| `KEYCLOAK_CLIENT_ID` | Client ID |
| `KEYCLOAK_CLIENT_SECRET` | Client Secret |

## Configuration

### group-mapping.yaml

The mapping file defines how IdP groups are translated to Octelium groups and policies:

```yaml
groups:
  # devops group -> devops group in Octelium with allow-all policy
  devops:
    displayName: "DevOps Team"
    policies:
      - allow-all
  
  # Rename group
  developers:
    octeliumGroup: developer
    displayName: "Developers"
    policies:
      - grafana
      - dev-db
  
  # Skip this group
  service-accounts:
    sync: false

defaults:
  unmappedGroups: skip  # skip | include | include-no-policies
  defaultPolicies: []
```

### Mapping Options

| Field | Description | Default |
|-------|-------------|---------|
| `octeliumGroup` | Target group name in Octelium | Same as IdP group name |
| `displayName` | Display name for the group | Same as IdP group name |
| `policies` | List of policies to attach | `defaults.defaultPolicies` |
| `sync` | Whether to sync this group | `true` |

### Default Behavior

| `unmappedGroups` | Description |
|------------------|-------------|
| `skip` | Groups not in mapping are ignored |
| `include` | Include with default policies |
| `include-no-policies` | Include without policies |

## GitLab CI Integration

Example `.gitlab-ci.yml` for `octelium-config` repository:

```yaml
variables:
  SYNC_IMAGE: ghcr.io/neuroplume/idp-octelium-sync:latest

stages:
  - sync
  - apply

sync-from-idp:
  stage: sync
  image: $SYNC_IMAGE
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
    - if: $CI_PIPELINE_SOURCE == "web"
      when: manual
  script:
    - |
      idp-octelium-sync sync \
        --provider keycloak \
        --keycloak-url $KEYCLOAK_URL \
        --keycloak-realm $KEYCLOAK_REALM \
        --keycloak-client-id $KEYCLOAK_CLIENT_ID \
        --mapping ./manual/group-mapping.yaml \
        --output-users ./generated/users.yaml \
        --output-groups ./generated/groups.yaml \
        --exclude-users "service-*,admin"
    
    - |
      if git diff --quiet generated/; then
        echo "No changes detected"
        exit 0
      fi
    
    - git config user.email "ci@example.com"
    - git config user.name "GitLab CI"
    - git add generated/
    - git commit -m "sync: update users and groups from IdP"
    - git push https://gitlab-ci-token:${GITLAB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:main

apply-to-octelium:
  stage: apply
  image: ghcr.io/octelium/octeliumctl:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - generated/**/*
        - manual/**/*
  script:
    - octeliumctl apply manual/
    - octeliumctl apply generated/
  tags:
    - octelium-runner
```

## Generated Output

### users.yaml

```yaml
# AUTO-GENERATED by idp-octelium-sync
# DO NOT EDIT MANUALLY - changes will be overwritten
---
kind: User
metadata:
  name: john-doe
spec:
  type: HUMAN
  email: john.doe@example.com
  groups:
    - devops
  attrs:
    source: keycloak
    keycloak-user-id: "abc-123"
    managed-by: idp-octelium-sync
```

### groups.yaml

```yaml
# AUTO-GENERATED by idp-octelium-sync
# DO NOT EDIT MANUALLY - changes will be overwritten
---
kind: Group
metadata:
  name: devops
  displayName: DevOps Team
spec:
  authorization:
    policies:
      - allow-all
  attrs:
    source: keycloak
    keycloak-group-id: "xyz-789"
    managed-by: idp-octelium-sync
```

## Development

```bash
# Install dependencies
bun install

# Run CLI
bun run src/index.ts sync --help

# Type check
bun run typecheck

# Build standalone binary
bun run build
```

## Adding a New Provider

1. Implement the `Provider` interface in `src/providers/{provider}.ts`
2. Add CLI options in `src/index.ts`
3. Register the provider in the sync command

```typescript
// src/providers/okta.ts
export class OktaProvider implements Provider {
  async connect(): Promise<void> { ... }
  async getUsers(): Promise<User[]> { ... }
  async getGroups(): Promise<Group[]> { ... }
  async getGroupMembers(groupId: string): Promise<User[]> { ... }
  async getUsersWithGroups(): Promise<UserWithGroups[]> { ... }
}
```

## License

MIT
